name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'dbt/**'
      - 'airflow/**'

env:
  PYTHON_VERSION: '3.9'
  ENVIRONMENT: production

jobs:
  # Pre-deployment validation
  pre-deploy-check:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deployment
        run: |
          echo "Running pre-deployment checks..."
          # Add validation logic here

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    environment:
      name: production
      url: https://your-dbt-docs-url.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install DBT
        run: pip install dbt-sqlserver==1.4.0

      - name: Configure DBT profiles for production
        shell: bash
        run: |
          mkdir -p ~/.dbt
          cat <<EOF > ~/.dbt/profiles.yml
          dbt_airflow_project:
            target: prod
            outputs:
              prod:
                type: sqlserver
                driver: 'ODBC Driver 17 for SQL Server'
                server: ${{ secrets.PROD_SQL_SERVER }}
                port: 1433
                database: AdventureWorks2014
                schema: dbo
                user: ${{ secrets.PROD_SQL_USER }}
                password: ${{ secrets.PROD_SQL_PASSWORD }}
                threads: 8
          EOF

      - name: Install DBT dependencies
        run: |
          cd dbt
          # dbt deps
          echo "Skipping dbt deps for testing"

      - name: Create backup snapshot
        run: |
          echo "Creating backup snapshot..."
          # In a real scenario, we would trigger a DB backup here

      - name: Run DBT models (Production)
        id: dbt_run
        run: |
          cd dbt
          # dbt run --profiles-dir ~/.dbt --target prod
          echo "Skipping dbt run for testing"

      - name: Run DBT tests (Production)
        id: dbt_test
        run: |
          cd dbt
          # dbt test --profiles-dir ~/.dbt --target prod
          echo "Skipping dbt test for testing"

      - name: Post-deployment health check
        run: |
          echo "Running health checks..."

      - name: Upload production logs
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-prod
          path: dbt/logs/
          retention-days: 90

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          draft: false
          prerelease: false

  # Rollback job (manual trigger)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: ${{ failure() && needs.deploy.result == 'failure' }}
    needs: deploy
    steps:
      - name: Trigger rollback (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Triggering rollback procedure..."
          $body = @{text=":warning: Production Deployment Rolled Back Ref: ${{ github.ref_name }}"} | ConvertTo-Json
          Invoke-WebRequest -Uri 'https://hooks.slack.com/services/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' -Method POST -Body $body -ContentType 'application/json'

      - name: Trigger rollback (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Triggering rollback procedure..."
          curl -X POST -H 'Content-type: application/json' --data '{"text":":warning: Production Deployment Rolled Back Ref: ${{ github.ref_name }}"}' https://hooks.slack.com/services/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

      - name: Notify on failure (Windows)
        if: failure() && runner.os == 'Windows'
        run: |
          echo "Deployment failed! Check logs for details."
          $body = @{text=":red_circle: Production Deployment Failed Ref: ${{ github.ref_name }}"} | ConvertTo-Json
          Invoke-WebRequest -Uri 'https://hooks.slack.com/services/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' -Method POST -Body $body -ContentType 'application/json'

      - name: Notify on failure (Linux)
        if: failure() && runner.os == 'Linux'
        shell: bash
        run: |
          echo "Deployment failed! Check logs for details."
          curl -X POST -H 'Content-type: application/json' --data '{"text":":red_circle: Production Deployment Failed Ref: ${{ github.ref_name }}"}' https://hooks.slack.com/services/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

      - name: Notify on success (Windows)
        if: success() && runner.os == 'Windows'
        run: |
          echo "Deployment succeeded!"
          $body = @{text=":white_check_mark: Production Deployment Successful Ref: ${{ github.ref_name }}"} | ConvertTo-Json
          Invoke-WebRequest -Uri 'https://hooks.slack.com/services/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' -Method POST -Body $body -ContentType 'application/json'

      - name: Notify on success (Linux)
        if: success() && runner.os == 'Linux'
        shell: bash
        run: |
          echo "Deployment succeeded!"
          curl -X POST -H 'Content-type: application/json' --data '{"text":":white_check_mark: Production Deployment Successful Ref: ${{ github.ref_name }}"}' https://hooks.slack.com/services/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

      - name: Cleanup workspace
        if: always()
        shell: bash
        run: |
          echo "Cleaning up workspace..."
          git clean -ffdx
          echo "Cleanup completed"
